
import os
import pickle
import pandas as pd
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split

prefix = '/opt/ml'
input_path = os.path.join(prefix, 'input/data/training')
output_path = os.path.join(prefix, 'model')

def train():
    print("Starting training...")

    try:
        files = [f for f in os.listdir(input_path) if f.endswith('.csv')]
        if not files:
            print("No CSV found in input.")
            return
            
        data_path = os.path.join(input_path, files[0])
        df = pd.read_csv(data_path)
        

        X = df.drop(columns=['G3']) if 'G3' in df.columns else df
        y = df['G3'] if 'G3' in df.columns else [0]*len(df)

        X_encoded = pd.get_dummies(X)

        rf = RandomForestRegressor(n_estimators=100)
        rf.fit(X_encoded, y)

        model_bundle = {
            "model": rf,
            "columns": list(X_encoded.columns)
        }

        with open(os.path.join(output_path, 'student_model_bundle.pkl'), 'wb') as out:
            pickle.dump(model_bundle, out)
            
        print("Training complete. Model saved.")
        
    except Exception as e:

        print(f"Training failed or no data: {e}. Moving pre-trained model instead.")
        import shutil
        if os.path.exists('student_model_bundle.pkl'):
            shutil.copy('student_model_bundle.pkl', os.path.join(output_path, 'student_model_bundle.pkl'))

if __name__ == '__main__':
    train()
